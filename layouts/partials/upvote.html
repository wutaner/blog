{{ if and .IsPage .File }}
{{ $hash_id := .File.Path | sha256 }}
<div class="upvote-container">
    <form class="upvote-form" data-post-id="{{ $hash_id }}">
        <button type="submit" class="upvote-button" aria-label="点赞">
            <svg class="upvote-icon" viewBox="0 0 24 24" width="24" height="24">
                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
            </svg>
            <span class="upvote-count">0</span>
        </button>
    </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('.upvote-form');
    
    forms.forEach(form => {
        const postId = form.dataset.postId;
        const button = form.querySelector('.upvote-button');
        const countSpan = form.querySelector('.upvote-count');
        
        // 检查是否已经点赞
        fetch(`https://blog-upvote.sjk131.workers.dev/?id=${postId}`)
            .then(response => response.json())
            .then(data => {
                countSpan.textContent = data.count;
                // 如果点赞数大于0，检查是否已经点赞
                if (data.count > 0) {
                    const hashId = generateHashId();
                    fetch(`https://blog-upvote.sjk131.workers.dev/?id=${postId}&hash=${hashId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error === 'Already upvoted') {
                                button.classList.add('upvoted');
                            }
                        });
                }
            });
        
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const hashId = generateHashId();
                const response = await fetch(`https://blog-upvote.sjk131.workers.dev/?id=${postId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Hash-Id': hashId
                    }
                });
                
                const data = await response.json();
                
                if (data.error === 'Already upvoted') {
                    button.classList.add('upvoted');
                    return;
                }
                
                countSpan.textContent = data.count;
                button.classList.add('upvoted');
            } catch (error) {
                console.error('Error upvoting:', error);
            }
        });
    });
});

function generateHashId() {
    const year = new Date().getFullYear();
    const encoder = new TextEncoder();
    const data = encoder.encode(year.toString());
    return Array.from(new Uint8Array(crypto.getRandomValues(new Uint8Array(32))))
        .map(b => b.toString(16).padStart(2, '0')).join('');
}
</script>

<style>
.upvote-container {
    display: inline-block;
    margin: 1rem 0;
}

.upvote-form {
    margin: 0;
    padding: 0;
}

.upvote-button {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border: 1px solid #e2e8f0;
    border-radius: 0.5rem;
    background: white;
    color: #64748b;
    cursor: pointer;
    transition: all 0.2s;
}

.upvote-button:hover {
    background: #f8fafc;
    border-color: #cbd5e1;
}

.upvote-button.upvoted {
    background: #fee2e2;
    border-color: #fecaca;
    color: #ef4444;
}

.upvote-icon {
    fill: currentColor;
    transition: transform 0.2s;
}

.upvote-button:hover .upvote-icon {
    transform: scale(1.1);
}

.upvote-count {
    font-size: 0.875rem;
    font-weight: 500;
}
</style>
{{ end }} 