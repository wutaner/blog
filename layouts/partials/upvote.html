{{ if and (eq .Site.Params.enableUpvote true) .Site.Params.githubToken .IsPage }}
<form class="upvote-form" style="display: inline"><small><input hidden name="uid" value="{{ .Page.RelPermalink }}"><button class="upvote-button" title="Upvote"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 11 12 6 7 11"></polyline><polyline points="17 18 12 13 7 18"></polyline></svg><small class="upvote-count">0</small></button></small></form>

<style>
.upvote-button {
    padding: 0;
    margin: 0;
    border: 0;
    background-color: inherit;
    color: inherit;
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
}
.upvote-button.upvoted {
    color: salmon;
}
.upvote-count {
    margin-top: -3px;
}
</style>

<script>
(function() {
    const token = `{{ .Site.Params.githubToken }}`;
    const gistId = `{{ .Site.Params.gistId }}`;
    
    // 初始化时获取点赞数
    async function fetchUpvotes() {
        try {
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                headers: {
                    'Authorization': `token ${token}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                const content = data.files['upvotes.json'].content;
                return JSON.parse(content || '{}');
            }
            return {};
        } catch (error) {
            console.error('Error fetching upvotes:', error);
            return {};
        }
    }

    // 页面加载时获取点赞数
    fetchUpvotes().then(upvotes => {
        const postId = document.querySelector('input[name="uid"]').value;
        const countElement = document.querySelector('.upvote-count');
        const button = document.querySelector('.upvote-button');
        
        // 更新显示的点赞数
        if (upvotes[postId]) {
            countElement.innerHTML = upvotes[postId];
        }
    });
    
    document.querySelector('.upvote-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const button = form.querySelector('button');
        const countElement = form.querySelector('.upvote-count');
        const postId = form.querySelector('input[name="uid"]').value;
        
        try {
            // 先获取现有点赞数据
            const upvotes = await fetchUpvotes();
            
            // 更新点赞数
            upvotes[postId] = (upvotes[postId] || 0) + 1;
            
            const response = await fetch(`https://api.github.com/gists/${gistId}`, {
                method: 'PATCH',
                headers: {
                    'Authorization': `token ${token}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/vnd.github.v3+json'
                },
                body: JSON.stringify({
                    files: {
                        'upvotes.json': {
                            content: JSON.stringify(upvotes)
                        }
                    }
                })
            });
            
            if (response.ok) {
                button.disabled = true;
                button.style.color = "salmon";
                countElement.innerHTML = upvotes[postId];
            } else {
                const errorData = await response.json();
                console.error('Upvote failed:', errorData);
                alert('Failed to upvote: ' + (errorData.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Error during upvote:', error);
            alert('Error during upvote: ' + error.message);
        }
    });
})();
</script>
{{ end }} 